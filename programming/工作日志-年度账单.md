# 工作日志, 年度账单

好久没有写过工作日志了, 这次也没有想到回去写. 只是做到这里才发现自己想记录下来.
2018年饿了么年度账单, 可能是我从业以来, 参与到的涉及用户面最大, 重要程度最多的一个项目. 虽然我只是参与, 但经过连续一周多的高强度加班也是我好久没有经历的事情了. 而且中间涉及的问题, 确实也是比较头疼.

## 跨域造成tained canvas无法导出.
这个项目, 我们在很早之处就加上了CDN, 但后面发现canvas对于图片的渲染导出是有同源限制的安全策略的. 导致我们最后生成用户画像无法正常导出. 因为这个问题, 我直觉就觉得棘手, 因为前面的图片你还是要保证从cdn的正常加载. 否则用户量一大, 爬把我们公共的基础服务faas搞垮,虽然公司成熟的基础架构项目应该不至于这么脆弱, 但我们由于不清楚最坏情况是什么, 就不敢贸然尝试. 但我为了保证测试能够正常进行, 就先禁用了CDN的配置. 

后来, 我终于找出时间, 静下来去解决这个问题. 我们cdn的配置, 是通过设置webpack的publicPath来做的, 有一个关键词变量`__CDN__`类似这样的东西, 当我们把静态文件, 通过faas打包部署到服务器上的时候, faas会自动替换这个变量. 但这种方式是一个全局的方式. 我需要把只有最后一页导出用户画像的那部分的图片抽离出来.

这个时候, 我能考虑的就是自定义webpack的file-loader的行为. 在github repo上看了文档. 我知道要配置某些函数, 但愣是没有看明白那些函数是怎么工作的. 我只好拉下file-loader的repo需研究了下内部的行为. 才发现你完全可以通过函数来自己定义file-loader在输出的在OS文件目录的资源路径, 还有代码里边的文件路径. 

那这个问题, 我就解决了一部分. 因为在应用过程中才发现, 仍然会有tained canvas问题, 因为css是在cdn域名下, 而css的图片呢, 又有一部分经过了url-loader inline 掉了, 从而没有走我定义的file-loader规则. 无奈, 我就需要该url-loader, clone下来, url-loader里边没有用的文件(单元测试), 依赖, 然后改里边代码, 终于觉得把该做的都做了之后. 发现webpack仍然没能正确解析我自己的loader, 查询文档发现webpack只能通过名字来配置loader选项, 而它会根据既有的规则去解析loader. 这个事情苦恼我很久, 后来在一位同事的提醒下, 可以将目录以相对路径的形式做npm安装. 这个问题终于得到解决.

在中午味千吃饭聊天的时候, 说道了我目前的解决方式. 他们觉得我还是有一部分图片文件没能走cdn(最后画像页), 然后还是这位同事提醒我可以通过webpack的dynamic import来做, 因为底层是走的jsonp, 这一下就点醒了我.

回去之后, 改了下url-loader, 将最后的画像页面全部走url-loader转成base64然后加载. 这个问题就算是得到圆满解决.

## 优化html2canvas的导出性能

我们代码的逻辑是这样, 首先会有个全面的用户画像展示在用户手机屏幕上, 然后截屏的时候外边需要包一个类似相框的东西. 代码最开始的实现是通过用html2canvas先截一个屏, 生成一张图片之后, 再讲这个图片插入到相框元素里边, 再一次用html2canvas做导出. 两步, 然后我的思路就是说, 如果能用iframe去把第一帧(张)图片的生成skip掉的话就会好很多. 然后我就试着通过动态创建iframe, 然后将对应的节点做一次deep clone插入到iframe中. 然后只截取第二帧图片就好了. 

我在尝试做这个的时候, 中间遇到很多难以描述的坑. 给我最直观的是, 第二帧的相框里的人物怎么弄, 都不存在. 我一直以为是html2canvas对iframe的加载时机掌握的不对, 所以导致被clone的人物节点插入的时候img元素还没有正常加载出来就截取了. 还有我也一度怀疑html2canvas在drawImage的时候, 没有能正确计算出人物的位置, 画到canvas可视的外部去了.

但由于我没有证据去证实这个观点. 我就不得不研究html2canvas的工作方式, 第一天晚上, 我没能有心情去看它代码, 只能在node_modules目录下修改它来打log查看差别, 这个问题怪就怪在有时候人物会出现在相框里, 有时候不会. 后来草率的看了一遍它代码, 打了log, 研究了好久. 也没能猜测到正确位置.


后来实在第二天,可能是, 我决定换一个思路, 因为iframe可能有加载时机的问题, 所以会判断不准. 我就直接在原document clone节点, 然后用css做scale, 但也是各种诡异问题. 人物也会时不时不正确加载. 我怀疑scale有类似的动画的延迟, 也怀疑元素中的zIndex有问题, 也怀疑html2canvas对transition不支持. 对各种猜测的各种尝试, 浪费了我太多时间, 也没能找到最终原因. 后来才灵机发现了是该人物元素的节点为了保证动画设置了个高度0, oveflow: hidden;这样的属性. 因为用户生成的动画是人物逐渐显现出来, 而该方式的实现就是依赖于设置高度还有元素基于底部的绝对定位. 但问题是, 在clone的时候, css默认的设定是0, 所以就有问题. 最终在clone完之后, 改变了该元素的style的height, 这个问题才最终解决.


但最终, 自己的代码没被采用. 因为他们发现压缩完图片之后, 性能和时间都在可接受范围之内. 我的代码就这么被扔在了分支的角落里. 好的一面是, 我知道html2canvas的机制是通过iframe整个克隆文档的dom节点, 来做的, 这意味着我意识到可以通过官网提供的参数去配置clone哪些元素, 这样由于克隆元素变少, 意味着性能, 内存占用就会有优化. 还有的一点是, 我大致知道html2canvas是怎么工作的了, clone document, 创建iframe, 然后parse里边要生成的元素, 这一步只是为了normalize要最终canvas生成需要用的属性(path, color, imgs...etcs), 然后用resource loader去下载对应的资源, 然后创建stack, 最终会用统一的方式画到canvas上边.

这也让我意识到, 有的时候简单粗暴的方式可能是比较优越的方式, 因为不会让你over-enginering而浪费大量的时间, 用户也能接受.



## swiper 的性能问题
这个问题的原因是由于我们采用了swiper的默认行为, 即swiper自己来控制滚动, 我们只是在特定的时间节点对于其滚动的禁用的状态位去做设置, 比如allowSwipePrev, 这种, 如果说项目上, 没有要求禁用, 默认的行为是没有问题的. 但倒数第二页面到最后一页需要禁用, 但倒数第一往前不能禁用, 最后一页往前也需要禁用. 这种通过设置状态位, 表示我们必须去监听事件来控制swiper行为. 

然后测试, 发现的问题就是连续滚动(上下), 页面会卡顿在倒数第二页, 切不能snap到正确的边界位置. 

说实话, 测试同学说快速滑动, 我就没有放在心上, 因为正常人并没有这种骚操作. 但过了几天, 由于测试的坚持, 我要了下他们的录屏视频, 发现在相对慢的情况下swiper的性能依旧很卡. 这我就意识到这里边是有问题的(1. 难以控制enable & disable swiper的状态 2. 由于竞争的问题, swiper需要判断滚动到那个位置, 但用户手势在不停的操作, 导致了竞争问题, 最终呈现的效果, 就是swiper没能正确snap到正确位置边界). 但由于自己本身项目的问题, 我到下午2点左右才开始修这个问题, 思路很简单, 我来监听swip手势, 然后通知swiper去滚动. 代码瞬间就好维护了, 而且性能上得到了明显的提升.

但我发现还有另一个问题, 就是微信默认会监听向下滑动, 来展示它内嵌的webview信息.导致我没能正确监听向下滑动. 最终, 在我在网上找到资料禁用了这个行为之后, 一切终于ok.


## 微信不能在退出再登录之后正确刷出背景层.
这个问题始终始终是我目前没能解决的问题, 这个问题很诡异, 就是用户在退出微信, 第一次扫码进入我们的页面, 会有一定概率刷不出背景层.

诡异的是img标签能正常加载, background-image的设置却一直不能生效. css 确实已经者正确加载了, 因为布局结构还在. 这个问题, 我清楚的记得是从周五下午5点一直去修, 修到凌晨2点半都没能解决. 问题的核心是这个东西不能稳定复现, 而且没有任何错误或者症状去让我查因.我只能胡乱尝试. 最终当天的结果, 花了我7个小时, 始终没能解决. 这就非常傻逼了.

第二天, 我开始删代码, 删到我认为不能再删了, 也仍然找不到问题的核心. 后来我打算放弃找原因了, 直接用我观察的表象, 即img正常能加载, 我就在元素的下边prepend了一个img元素. 最终却因为沟通问题, 导致我自己的改动没有被验证, 也就意味着这个努力也是被浪费掉了.



## 感悟
经过近一周的连续加班, 包括每周的周六, 还有在这个同时我还要兼顾自己本身的项目. 可以说, 我自己牺牲了很多. 我以为我在做正确的事, 在为自己的团队贡献自己的力量. 但项目越进行到后面, 我只感觉自己心力交瘁, 一方面是自己的努力没有得到期望的回报(事实上一直如此), 第二方面也是自己把自己的重要性看的太重了, 事实上, 我可能根本就不被需要. 这一直是我自己的问题. 我没能控制好自己, 又因为工作将自己的生活吞噬. 第三一点就是我意识到自己想要的东西了, 就是控制性, 在我看来, 不能按照我自己意志去塑造的产品对于我来说是没有意义的. 还有一点没有做好的是, 当初的技术选型, 我任性的同意了我不熟悉的框架vue, 导致在配置很多东西的时候茫然, 处理特定问题也不够灵活, 虽然学习到了些知识, 比如chained webpack, 但大多数时候是得不偿失的. 浪费的时间是我最心疼的.

当然这项目过程中肯定有些好的方面, 让我在短暂又高强度的时间里边收获了些知识, 同时让我可惜的是在处理一些问题, 由于欠缺思考, 直接去用不同方式撞南墙的方式简直蠢的一逼. 浪费了我太多的时间. 尤其是周五那天晚上, 熬夜造成的副作用在周六倍显, 整个人的状态都是颓废的一匹.































